---
layout: post
title: Regular Expression Denial of Service.
categories: [Research]
tags: [REGULAR-EXPRESSION,DOS]
description: Something about Regular expression DoS.
---

## 0x00 Má»™t sá»‘ thá»© liÃªn quan tá»›i tiÃªu Ä‘á» bÃ i viáº¿t

Thi thoáº£ng mÃ¬nh váº«n hay lÆ°á»›t [Security Lab](https://securitylab.github.com/) Ä‘á»ƒ Ä‘á»c nhá»¯ng bÃ i nghiÃªn cá»©u, thÃ¬ cÃ³ dáº¡o mÃ¬nh Ä‘á»c qua [GHSL-2021-098: ReDoS in OpenProject - CVE-2021-32763](https://securitylab.github.com/advisories/GHSL-2021-098-opf-openproject/) . Lá»—i nÃ y mÃ´ táº£ chi tiáº¿t sáº£n pháº§m [OpenProject](https://www.openproject.org/) bá»‹ khai thÃ¡c [DoS](https://en.wikipedia.org/wiki/Denial-of-service_attack),thÃ´ng qua viá»‡c so khá»›p chuá»—i vá»›i **patern regex** khÃ´ng cháº·t cháº½ hay cÃ²n gá»i lÃ  **evil regex**. Tá»« khoÃ¡ **ReDoS** mÃ¬nh cÅ©ng tháº¥y vÃ i láº§n nhÆ°ng tá»± vÃ£ vÃ o máº·t mÃ¬nh mÃ  nÃ³i thÃ¬ mÃ¬nh Ä‘Æ¡n thuáº§n chá»‰ nghÄ© nÃ³ lÃ  **Bypass DoS** cá»§a má»™t lá»—i nÃ o trÆ°á»›c Ä‘Ã¢y mÃ  thÃ´i. NhÆ°ng sá»± tháº­t thÃ¬ **ReDoS** lÃ  cÃ¡ch viáº¿t ngáº¯n gá»n **R**egular-**e**xpression-**D**enial-**o**f-**S**ervice.

![Stop acting so stupid! | Reaction Images | Know Your Meme](https://i.kym-cdn.com/photos/images/newsfeed/000/555/907/765.gif)

TrÆ°á»›c khi nÃ³i chi tiáº¿t vÃ o cÃ¡ch mÃ  **ReDoS** hoáº¡t Ä‘á»™ng thÃ¬ mÃ¬nh sáº½ nÃ³i láº¡i má»™t chÃºt vá» [NFA(Nondeterministic finite automaton)](https://en.wikipedia.org/wiki/Nondeterministic_finite_automaton) vÃ  [DFA(Deterministic_finite_automaton)](https://en.wikipedia.org/wiki/Deterministic_finite_automaton). 

> **NFA/DFA** lÃ  2 hÃ m chuyá»ƒn Ä‘á»•i tráº¡ng thÃ¡i nháº­n vÃ o **Q** táº­p há»£p há»¯u háº¡n cÃ¡c tráº¡ng thÃ¡i,**âˆ‘** lÃ  báº£ng chá»¯ - táº­p cÃ¡c kÃ½ tá»± vÃ o, **q0** lÃ  tráº¡ng thÃ¡i báº¯t Ä‘áº§u vÃ  cho ra táº­p **F**  tráº¡ng thÃ¡i káº¿t thÃºc(tráº¡ng thÃ¡i thÃ nh cÃ´ng). 

MÃ¬nh sáº½ khÃ´ng giáº£i thÃ­ch nhiá»u vá» pháº§n nÃ y, cÃ¡c báº¡n cÃ³ thá»ƒ tham kháº£o thÃªm táº¡i [bÃ i giáº£ng](https://www.slideshare.net/cumeo89/l-thuyt-tnh-ton-bkhn-3) nÃ y. NgoÃ i ra náº¿u muá»‘n tÃ¬m hiá»ƒu sÃ¢u hÆ¡n thÃ¬ cÃ³ thá»ƒ xem qua [what-is-the-enlightenment-im-supposed-to-attain-after-studying-finite-automata](https://qastack.vn/cstheory/14811/what-is-the-enlightenment-im-supposed-to-attain-after-studying-finite-automata). TiÃªu Ä‘á» khÃ¡ hÃ i nhÆ°ng mÃ¬nh ráº¥t thÃ­ch Ä‘á»c cÃ¡c bÃ i viáº¿t há»i Ä‘Ã¡p vÃ  tranh luáº­n nhÆ° nÃ y. Hai Ä‘áº·c Ä‘iá»ƒm chÃ­nh cá»§a **NFA/DFA** cÃ³ liÃªn quan Ä‘áº¿n pháº§n tiáº¿p theo:

*<u>NFA:</u>*

> - HÃ m chuyá»ƒn Ã¡nh xáº¡: **Q** x **âˆ‘** â™ **2^Q**. Tá»©c á»©ng vá»›i má»™t tráº¡ng thÃ¡i vÃ  má»™t kÃ­ tá»± nháº­p, cÃ³ thá»ƒ cÃ³ **khÃ´ng**, **má»™t** hoáº·c **nhiá»u** phÃ©p chuyá»ƒn tráº¡ng thÃ¡i 
> - Cháº¥p nháº­n Îµ (kÃ­ hiá»‡u rá»—ng)

â€‹       Tráº£ lá»i cho cÃ¢u há»i Îµ lÃ  gÃ¬ táº¡i Ä‘Ã¢y : [What-is-Îµ-NFA](https://www.quora.com/What-is-%CE%B5-NFA) hoáº·c [Epsilon NFA](https://www.youtube.com/watch?v=84oNUttWlN4)

```
Îµ(epsilon) giÃºp chuyá»ƒn Ä‘á»•i tráº¡ng thÃ¡i mÃ  khÃ´ng cáº§n kÃ­ tá»± Ä‘áº§u vÃ o, chuyá»ƒn tiáº¿p tá»« tráº¡ng thÃ¡i q(a) sang tráº¡ng thÃ¡i q(b) nhÆ° má»™t chuá»—i rá»—ng.
```

*<u>DFA:</u>*

> * HÃ m chuyá»ƒn Ã¡nh xáº¡: **Q** x **âˆ‘** â™ **Q**. Tá»©c á»©ng vá»›i má»™t tráº¡ng thÃ¡i vÃ  má»™t kÃ­ tá»± nháº­p, chá»‰ cÃ³ thá»ƒ cÃ³ **má»™t** phÃ©p chuyá»ƒn tráº¡ng thÃ¡i.
> * KhÃ´ng cháº¥p nháº­n Îµ (kÃ­ hiá»‡u rá»—ng)

> Tráº¡ng thÃ¡i trong DFA lÃ  táº­p há»£p con cá»§a cÃ¡c tráº¡ng thÃ¡i trong NFA

## 0x01 CÃ¡ch ReDoS hoáº¡t Ä‘á»™ng

Hiá»‡n nay, háº§u háº¿t cÃ¡c bá»™ mÃ¡y regular expression trong cÃ¡c ngÃ´n ngá»¯ láº­p trÃ¬nh Ä‘á»u tuÃ¢n theo [thuáº­t toÃ¡n cá»§a Ken Thompson's](https://en.wikipedia.org/wiki/Thompson%27s_construction) Ä‘á»ƒ xÃ¢y dá»±ng NFA tá»« má»™t regular expression. Káº¿t quáº£ tráº£ vá» tá»« bá»™ mÃ¡y nÃ y lÃ  tráº¡ng thÃ¡i thÃ nh cÃ´ng vá»›i chuá»—i kÃ­ tá»± khá»›p, hoáº·c má»™t tráº¡ng thÃ¡i rá»—ng khi NFA Ä‘Ã£ duyá»‡t qua háº¿t táº¥t cáº£ nhá»¯ng tráº¡ng thÃ¡i cÃ³ thá»ƒ xáº£y ra trong táº­p há»£p cÃ¡c tráº¡ng thÃ¡i mÃ  khÃ´ng cÃ³ cÃ³ má»™t chuá»—i khá»›p nÃ o.

<u>*VÃ­ dá»¥ 1: *</u>Má»™t vÃ­ dá»¥ vá» cÃ¡c Ä‘Æ°á»ng Ä‘i tráº¡ng thÃ¡i tá»« cÃ¹ng má»™t máº«u regular expression `a(b|c)e` vÃ  chuá»—i Ä‘áº§u vÃ o `abe` giá»¯a **NFA** vÃ  **DFA** bá»Ÿi [fsm_simulator](http://ivanzuzak.info/noam/webapps/fsm_simulator/):

![dfa](https://user-images.githubusercontent.com/32236617/131471914-062343c4-3601-4ac3-bece-f359fdf675d5.gif)

â€‹                                                                                       *VÃ­ dá»¥ 1:DFA Transition graph*

![nfa](https://user-images.githubusercontent.com/32236617/131472286-8c939c8c-caf5-41f2-9f96-37b19ea86a2d.gif)

â€‹                                                                                           *VÃ­ dá»¥ 1:NFA Transition graph*

Biá»ƒu Ä‘á»“ duyá»‡t tráº¡ng thÃ¡i NFA trÃªn váº«n cÃ²n quÃ¡ Ä‘Æ¡n giáº£n Ä‘á»‘i vá»›i kháº£ nÄƒng xá»­ lÃ½ cá»§a mÃ¡y tÃ­nh. VÃ­ dá»¥ tiáº¿p theo Ä‘Ã¢y mÃ¬nh sáº½ giáº£i thÃ­ch vá» `backtracking`, quay lÃ¹i cho Ä‘áº¿n khi tÃ¬m tráº¡ng thÃ¡i Ä‘Æ°á»£c cháº¥p nháº­n hoáº·c Ä‘Ã£ duyá»‡t qua táº¥t cáº£ nhá»¯ng thÃ¡i cÃ³ thá»ƒ xáº£y ra.

<u>*VÃ­ dá»¥ 2:*</u> Táº­p tráº¡ng thÃ¡i Ä‘áº§u vÃ o gá»“m `{acgf,acdf}`. Tráº¡ng thÃ¡i káº¿t thÃºc thÃ nh cÃ´ng lÃ  `acdf`, bá»™ mÃ¡y sáº½ xá»­ lÃ½ nhÆ° tháº¿ nÃ o?

*TÃ³m táº¯t:*

* Gá»“m 2 Ä‘Æ°á»ng Ä‘i tráº¡ng thÃ¡i
* NÃºt báº¯t Ä‘áº§u lÃ  nÃºt `0` á»©ng vá»›i kÃ­ tá»± báº¯t Ä‘áº§u `a`
* NÃºt káº¿t thÃºc lÃ  `4` á»©ng vá»›i kÃ­ tá»± káº¿t thÃºc lÃ  `f`



![image](https://user-images.githubusercontent.com/32236617/131476224-3502e189-61e3-43a0-b5f1-37689d19175e.png)

â€‹                                                                               *VÃ­ dá»¥ 2: ÄÆ°á»ng Ä‘i khÃ´ng khá»›p máº«u*

Äáº§u tiÃªn cáº£ 2 Ä‘Æ°á»ng Ä‘i tráº¡ng thÃ¡i nÃ y Ä‘á»u Ä‘i Ä‘áº¿n nÃºt `2` vÃ  `6` vá»›i cÃ¡c tráº¡ng thÃ¡i cá»§a 2 Ä‘Æ°á»ng Ä‘i nÃ y Ä‘á»u giá»‘ng nhau.Sau Ä‘Ã³ Ä‘Æ°á»ng tráº¡ng thÃ¡i bÃªn trÃªn báº¯t Ä‘áº§u duyá»‡t qua nÃºt `3` vá»›i kÃ­ tá»± `g`. KÃ­ tá»± `g` khÃ´ng náº±m trong tráº¡ng thÃ¡i cho phÃ©p `acdf`.

[âŒ](https://emojipedia.org/cross-mark/)*Káº¿t thÃºc Ä‘Æ°á»ng tráº¡ng thÃ¡i táº¡i nÃºt nÃ y vÃ  xem nhÆ° tráº¡ng thÃ¡i tháº¥t báº¡i lÃ  `acgf`.*

![image](https://user-images.githubusercontent.com/32236617/131476496-17257736-8a6c-41c5-bfa9-6245cc8f3bd4.png)

â€‹                                                                               *VÃ­ dá»¥ 2: ÄÆ°á»ng Ä‘i khÃ´ng khá»›p máº«u*

LÃºc nÃ y, `backtracking` hoáº¡t Ä‘á»™ng, báº¯t Ä‘áº§u lÃ¹i láº¡i nÃºt nÆ¡i cuá»‘i cÃ¹ng khi 2 nÃºt cÃ³ tráº¡ng thÃ¡i tÆ°Æ¡ng Ä‘á»“ng trÃªn cáº£ 2 Ä‘Æ°á»ng Ä‘i tá»©c `2` vÃ  `6`. NÃºt `2` Ä‘Ã£ bá»‹ loáº¡i á»Ÿ bÆ°á»›c trÃªn, nÃªn thá»±c hiá»‡n duyá»‡t tiáº¿p tá»« nÃºt `6`. Duyá»‡t Ä‘áº¿n nÃºt `7` lÃ  kÃ­ tá»± `d` khá»›p vá»›i tráº¡ng thÃ¡i cho phÃ©p vÃ  Ä‘i tá»›i nÃºt `4` Ä‘á»ƒ káº¿t thÃºc.

[âœ”ï¸](https://emojipedia.org/check-mark/) *Káº¿t thÃºc Ä‘Æ°á»ng tráº¡ng thÃ¡i táº¡i nÃºt nÃ y vÃ  xem nhÆ° tráº¡ng thÃ¡i thÃ nh cÃ´ng lÃ  `acdf`.*

> HÃ£y thá»­ nghÄ© ráº±ng náº¿u trÆ°á»ng há»£p táº­p cÃ¡c tráº¡ng thÃ¡i Ä‘áº§u vÃ o khÃ´ng bao gá»“m tráº¡ng thÃ¡i káº¿t thÃºc **thÃ nh cÃ´ng**, táº­p cÃ¡c tráº¡ng thÃ¡i cÃ³ khoáº£ng **2^n** tráº¡ng thÃ¡i thÃ¬ CPU sáº½ cáº§n bao nhiÃªu tÃ i nguyÃªn vÃ  thá»i gian Ä‘á»ƒ duyá»‡t háº¿t táº­p tráº¡ng thÃ¡i nÃ y?

<u>*VÃ­ dá»¥ 3:*</u> Má»™t tiá»‡n Ã­ch javascript sá»­ dá»¥ng máº«u regular expression `(^Author:|^Co-authored-by:)\s+(?<author>[^<]+)\s+(?<email><[^>]+>)` vá»›i chá»©c nÄƒng láº¥y ra láº¥y ra cÃ¡c chuá»—i khá»›p vá»›i tÃªn, Ä‘á»‹a chá»‰ email cá»§a ngÆ°á»i ngÆ°á»i dÃ¹ng. Liá»‡u nÃ³ cÃ³ an toÃ n khÃ´ng?

Sá»­ dá»¥ng chá»©c nÄƒng [debugger regex101.com](https://regex101.com/debugger) Ä‘á»ƒ cÃ³ thá»ƒ xem cÃ¡c bÆ°á»›c duyá»‡t chuá»—i khá»›p máº«u.

* TrÆ°á»ng há»£p thá»© nháº¥t, chuá»—i nháº­p vÃ o tráº£ vá» tráº¡ng thÃ¡i cho phÃ©p (khá»›p): `Author: dangkhai0x21 <dangkhai0x21@gmail.com>`

![match](https://user-images.githubusercontent.com/32236617/131513732-60bd7d47-854c-4015-ab64-3b6d59ed622b.gif)

â€‹                                                                           *VÃ­ dá»¥ 3: chuá»—i so khá»›p máº«u*

Vá»›i trÆ°á»ng há»£p nÃ y, cáº§n **23** bÆ°á»›c Ä‘á»ƒ tÃ¬m Ä‘Æ°á»£c chuá»—i khá»›p vá»›i máº«u. Vá»›i láº§n duyá»‡t Ä‘áº§u tiÃªn Ä‘Ã£ tÃ¬m Ä‘Æ°á»£c chuá»—i khá»›p.

* TrÆ°á»ng há»£p thá»© hai, chuá»—i nháº­p vÃ o khÃ´ng khá»›p vá»›i máº«u: `Author: dangkhai0x21    <dangkhai0x21@gmail.com`

![notmatch](https://user-images.githubusercontent.com/32236617/131514567-3424d6ba-2d24-4345-9c9b-aaf4e94e1e34.gif)

â€‹                                                                               *VÃ­ dá»¥ 3: chuá»—i khÃ´ng so khá»›p máº«u*

TrÆ°á»ng há»£p nÃ y cáº§n Ä‘áº¿n 204 bÆ°á»›c Ä‘á»ƒ xá»­ lÃ½ Ä‘áº§u vÃ o nÃ y. Káº¿t quáº£ tráº£ vá» khÃ´ng tÃ¬m Ä‘Æ°á»£c chuá»—i khá»›p nÃ o.

So sÃ¡nh 2 Ä‘áº§u vÃ o:

![image](https://user-images.githubusercontent.com/32236617/132949308-f8ff1d12-186d-4b7c-a6bf-315c4a75db4c.png)

 *LÃ­ do:* 

* `\s+` cho phÃ©p cÃ³ `1` hoáº·c `nhiá»u` kÃ­ tá»± **space**.
* NhÃ³m **group** báº¯t cÃ¡c kÃ­ tá»± khÃ´ng **cháº·t cháº½**
* Chuá»—i Ä‘áº§u vÃ o **khÃ´ng** bao gá»“m tráº¡ng thÃ¡i káº¿t thÃºc **thÃ nh cÃ´ng** vÃ¬ thiáº¿u kÃ­ tá»± `>`.

ğŸ” VÃ¬ nguyÃªn nhÃ¢n nÃ y mÃ  CPU cáº§n xá»­ lÃ½ 1 vÃ²ng láº·p há»¯u háº¡n bá»Ÿi káº» táº¥n cÃ´ng cÃ³ thá»ƒ tuá»³ biáº¿n báº±ng viá»‡c thÃªm hoáº·c bá»›t kÃ­ tá»± **space** á»Ÿ chuá»—i Ä‘áº§u vÃ o.

HÃ£y xem biá»ƒu Ä‘á»“ xá»­ lÃ½ Ä‘á»ƒ dá»… hÃ¬nh dung hÆ¡n: 

![image](https://user-images.githubusercontent.com/32236617/131606562-eff4915a-5151-4a08-97d1-00de3e25e06f.png)

â€‹                                                               *VÃ­ dá»¥ 3: Biá»ƒu Ä‘á»“ duyá»‡t Ä‘Æ°á»ng khi chuá»—i khÃ´ng khá»›p*

Biá»ƒu diá»…n `[space]` báº±ng kÃ­ tá»± `[s]` trÃªn biá»ƒu Ä‘á»“. **evil space** lÃ  kÃ­ tá»± **space** vÃ  káº» táº¥n cÃ´ng cÃ³ thá»ƒ tuá»³ chá»‰nh. CÃ¡c kÃ­ tá»± space sáº½ Ä‘Æ°á»£c chia lÃ m 2 pháº§n:

* Pháº§n thá»© nháº¥t sáº½ khá»›p vá»›i nhÃ³m `(?<author>[^<]+)`
* Pháº§n thá»© hai sáº½ khá»›p vá»›i `\s+`

Háº­u quáº£ cá»§a viá»‡c cho bá»™ mÃ¡y regular expression cháº¡y má»™t vÃ²ng láº·p vá»›i n Ä‘Æ°á»ng Ä‘i sáº½ nhÆ° tháº¿ nÃ o. Sá»­ dá»¥ng trÃ¬nh biÃªn dá»‹ch javascript Ä‘á»ƒ cháº¡y Ä‘oáº¡n mÃ£ dÆ°á»›i Ä‘Ã¢y:

```javascript
let regex = /(^Author:|^Co-authored-by:)\s+(?<author>[^<]+)\s+(?<email><[^>]+>)/
t = performance.now()
regex.test('Author: dangkhai0x21' + ' '.repeat(9999) + '<dangkhai0x21@gmail.com')
console.log(performance.now() - t)
```

![image-20210901103932152](https://user-images.githubusercontent.com/32236617/131949698-7c0eba61-d64f-419f-836c-b5b83745e7e8.png)

â€‹                                           *VÃ­ dá»¥ 3: Thá»i gian tráº£ vá» khi nháº­p vÃ o má»™t chuá»—i khÃ´ng an toÃ n sáº¥p xá»‰ 103 ms*

![image-20210901103959567](https://user-images.githubusercontent.com/32236617/131949727-d6b8050b-6e99-41f6-b528-873190d708c7.png)

â€‹                                               *VÃ­ dá»¥ 3: Thá»i gian tráº£ vá» khi nháº­p vÃ o má»™t chuá»—i an toÃ n lÃ  0 ms*

Náº¿u báº¡n thá»­ `repeat(999999999)` thÃ¬ ...

![Meme Creator - Funny end of month push... Whole computer system crashes..again.  Meme Generator at MemeCreator.org!](https://www.memecreator.org/static/images/memes/4159800.jpg)

NgoÃ i ra, qua cÃ¡c báº£n bÃ¡o cÃ¡o chi tiáº¿t á»Ÿ [CVE-2021-27293](https://github.com/restsharp/RestSharp/issues/1556),[ssri_redos](https://doyensec.com/resources/Doyensec_Advisory_ssri_redos.pdf) báº¡n Ä‘á»c cÃ³ thá»ƒ thÃ´ng tin vá» kiá»ƒu táº¥n cÃ´ng nÃ y.

## 0X02 ReDoS trong Whitebox


TÃ¬m kiáº¿m nÆ¡i cÃ³ thá»ƒ xáº£y ra ReDoS phá»• biáº¿n hÆ¡n trong Whitebox, vÃ¬ cÃ¡ch thá»©c phÃ¡t hiá»‡n loáº¡i táº¥n cÃ´ng nÃ y chá»§ yáº¿u phÃ¢n tÃ­ch cÃ¡c máº«u regular expression tá»« á»©ng dá»¥ng. Tá»« Ä‘Ã³ tÃ¬m ra cÃ¡c kÃ­ tá»± `potential` cÃ³ thá»ƒ dáº«n Ä‘áº¿n `backtracking`. 

ÄÃ£ cÃ³ nhiá»u nhÃ  nghiÃªn cá»©u Ä‘Ã³ng gÃ³p cÃ¡c cÃ´ng cá»¥ phÃ¢n tÃ­ch máº«u regular expression Ä‘á»™c háº¡i cÃ³ thá»ƒ phÃ¡t hiá»‡n ra háº§u háº¿t cÃ¡c máº«u cÃ³ kháº£ nÄƒng bá»‹ khai thÃ¡c. VÃ­ dá»¥ nhÆ°:

* [regexploit](https://github.com/doyensec/regexploit) phÃ¡t triá»ƒn bá»Ÿ [@doyensec](https://blog.doyensec.com/) há»— trá»£ khÃ¡ nhiá»u ngÃ´n ngá»¯ nhÆ° java,javascript,python.c-sharp
* [saferegex](1.https://github.com/jkutner/saferegex) phÃ¡t triá»ƒn bá»Ÿi @jkutner
* ...

> CÃ¡c cÃ´ng cá»¥ nÃ y Ä‘Ã£ lÃ m tá»‘t cÃ´ng viá»‡c cá»§a nÃ³ lÃ  tÃ¬m Ä‘Æ°á»£c cÃ¡c máº«u cÃ³ kháº£ nÄƒng gÃ¢y lá»—i Ä‘áº¿n 80%. Tuy nhiÃªn váº«n bá» qua má»™t sá»‘ máº«u phá»©c táº¡p.

## 0x03 ReDoS trong Blackbox

![wtf you did there I can&#39;t see it - Blind Attack | Meme Generator](https://memegenerator.net/img/instances/75163432.jpg)


Khai thÃ¡c ReDoS trong Blackbox Ã­t kháº£ hÆ¡n so vá»›i WhiteBox, vÃ¬ nÃ³ nhÆ° má»™t kiá»ƒu khai thÃ¡c **mÃ¹**. CÃ¡ch khai thÃ¡c váº«n chá»‰ cÃ³ thá»ƒ suy Ä‘oÃ¡n cÃ¡c tham sá»‘ dá»… bá»‹ táº¥n cÃ´ng nhÆ° cÃ¡c trÆ°á»ng `email, sá»‘ Ä‘iá»‡n thoáº¡i, session history...`. CÃ¡c trÆ°á»ng mÃ  á»©ng dá»¥ng yÃªu cáº§u sá»± phÃ¢n biá»‡t rÃµ rÃ ng bá»Ÿi kÃ­ tá»± thÆ°á»ng, in hoa, sá»‘, kÃ­ tá»± Ä‘áº·c biá»‡t. 

Sau khi tÃ¬m Ä‘Æ°á»£c cÃ¡c Ä‘iá»ƒm vÃ o cÃ³ thá»ƒ khai thÃ¡c thÃ¬ láº¡i cÃ³ 2 cÃ¡ch táº¥n cÃ´ng cÃ³ thá»ƒ dÃ¹ng:

* Thá»§ cÃ´ng 100%:
  - Bao gá»“m 2 bÆ°á»›c chÃ­nh sau khi tÃ¬m Ä‘Æ°á»£c Ä‘áº§u vÃ o cÃ³ kháº£ nÄƒng khai thÃ¡c lÃ  Ä‘Æ°a ra táº­p `n` **giáº£ Ä‘á»‹nh** máº«u regular expression tá»« server. BÆ°á»›c tiáº¿p lÃ  Ä‘Æ°a ra táº­p `m` chuá»—i Ä‘áº§u Ä‘á»™c háº¡i Ä‘á»ƒ láº§n lÆ°á»£t khai thÃ¡c cÃ¡c máº«u giáº£ Ä‘á»‹nh kia. CÃ³ thá»ƒ xem lÃ  máº¥t `n^m` bÆ°á»›c khai thÃ¡c.
* Semi(thá»§ cÃ´ng 50%, tá»± Ä‘á»™ng 50%):
  * **Bá» qua** bÆ°á»›c Ä‘Æ°a ra `n` giáº£ Ä‘á»‹nh máº«u mÃ  ngÆ°á»i khai thÃ¡c sáº½ tá»± gá»£i Ã½ máº«u regular expression. Sau Ä‘Ã³ sáº½ tá»± Ä‘á»™ng thá»±c hiá»‡n vÃ©t cáº¡n `m` chuá»—i vÃ o Ä‘á»™c háº¡i.

Äá»‘i vá»›i cÃ¡ch thá»§ cÃ´ng 100% kia mÃ¬nh sá»£ ráº±ng chÆ°a ká»‹p táº¥n cÃ´ng mÃ¡y chá»§ thÃ¬ mÃ¡y mÃ¬nh Ä‘Ã£ tá»± **crash** rá»“i. VÃ¬ váº­y mÃ  hiá»‡n táº¡i váº«n chÆ°a cÃ³ cÃ´ng cá»¥ nÃ o kháº£ quan Ä‘á»ƒ kiá»ƒm tra blackbox.

## 0x04 NgÄƒn cháº·n ReDoS

> LÃ m tháº¿ nÃ o Ä‘á»ƒ táº¡o ra máº«u regular expression vá»«a **linh hoáº¡t** vÃ  **an toÃ n**?

Vá»›i ngÆ°á»i má»™t sá»‘ báº¡n chÆ°a cÃ³ kiáº¿n thá»©c báº£o máº­t vá» pháº§n nÃ y Ä‘ang cá»‘ gáº¯ng táº¡o ra má»™t máº«u regular expression dÃ i ngoáºµn. Nháº±m má»¥c Ä‘Ã­ch báº¯t Ä‘Æ°á»£c nhiá»u nhÃ³m, nhiá»u má»¥c tiÃªu, báº¯t nÃ³ nhÆ° má»™t máº«u Ä‘a dá»¥ng. NhÆ°ng Ä‘Ã´i khi sáº½ biáº¿n tÃ­nh nÄƒng thÃ nh lá»— há»ng.

![image](https://user-images.githubusercontent.com/32236617/131681605-05c4c663-7d3b-433f-8685-c69d392cc84d.png)

Váº­y lÃ m sao Ä‘á»ƒ giáº£i quyáº¿t cÃ¢u há»i á»Ÿ trÃªn? MÃ¬nh sáº½ liá»‡t kÃª má»™t sá»‘ cÃ¡ch Ä‘á»ƒ háº¡n cháº¿ kháº£ nÄƒng bá»‹ khai thÃ¡c thÃ´ng qua máº«u nhÆ° sau:

* Sá»­ dá»¥ng DFA -> An toÃ n **nhÆ°ng** sáº½ khÃ´ng linh hoáº¡t vÃ¬ háº¡n cháº¿ cÃ¡c tráº¡ng thÃ¡i káº¿t thÃºc.

* Trá»Ÿ thÃ nh má»™t ngÆ°á»i viáº¿t máº«u chuáº©n 4.0:

  * Äá»«ng **cá»‘** gáº¯ng táº¡o ra má»™t máº«u **regular expression** quÃ¡ Ä‘a nhiá»‡m. ÄÃ´i khi sáº½ biáº¿n tÃ­nh nÄƒng thÃ nh lá»— há»ng. *Cá»‘ quÃ¡ sáº½ thÃ nh quÃ¡ cá»‘ >.<*

  * NÃªn rÃ ng buá»™c chiá»u dÃ i vá»›i cÃ¡c kÃ­ tá»± tá»± do:

    VÃ­ dá»¥ nhÆ° khÃ´ng sá»­ dá»¥ng `\s+` hoáº·c `\w+` `\d+` mÃ  nÃªn rÃ ng buá»™c chiá»u dÃ i `\s{1,3}` `\w{1,3}`

  * CÃ³ thá»ƒ sá»­ dá»¥ng **backreferences** Ä‘á»ƒ kiá»ƒm tra sá»‘ láº§n láº·p láº¡i cá»§a kÃ­ tá»± Ä‘á»ƒ loáº¡i bá» cÃ¡c kÃ­ tá»± trÃ¹ng.

  * HÃ£y xÃ©t thá»i gian thá»±c hiá»‡n cho cÃ¡c láº§n sá»­ dá»¥ng mÃ¡y regex, náº¿u trÆ°á»ng há»£p viá»‡c xá»­ lÃ½ Ä‘áº§u vÃ o quÃ¡ lÃ¢u thÃ¬ cÃ³ thá»ƒ dá»«ng tiáº¿n trÃ¬nh vÃ  thÃ´ng bÃ¡o chuá»—i phá»©c táº¡p.

  * Sá»­ dá»¥ng `*` vÃ  `+` Ä‘Ãºng lÃºc Ä‘Ãºng chá»—.

  * Báº¯t chÃ­nh xÃ¡c cÃ¡c chuá»—i thuá»™c `group`.

  * Sá»­ dá»¥ng cÃ¡c thÆ° viá»‡n khÃ¡c nhÆ° `strip,trim,replace,...` Ä‘á»ƒ lÃ m sáº¡ch cÃ¡c Ä‘áº§u vÃ o trÆ°á»›c khi dÃ¹ng Ä‘áº¿n regular expression.

  * ...

## 0X05 TÃ i liá»‡u liÃªn quan

[0] [Regular Expression Matching Can Be Simple And Fast (but is slow in Java, Perl, PHP, Python, Ruby, ...)](https://swtch.com/~rsc/regexp/regexp1.html)

[1] [implementing-a-regular-expression-engine](https://deniskyashif.com/2019/02/17/implementing-a-regular-expression-engine/)

[2] [Details of regular expression behavior](https://docs.microsoft.com/en-us/dotnet/standard/base-types/details-of-regular-expression-behavior)

[3] [Construct âˆˆ-NFA of Regular Language L = 0(0+1)*1](https://www.tutorialspoint.com/construct-nfa-of-regular-language-l-0-0plus1-1)

[4] [ReDoS-Attacks](https://www.checkmarx.com/wp-content/uploads/2015/03/ReDoS-Attacks.pdf)

[5] [NFAs and regular expressions](https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-045j-automata-computability-and-complexity-spring-2011/lecture-notes/MIT6_045JS11_lec04.pdf)

[6] [regular-expressions.info](https://www.regular-expressions.info/catastrophic.html)

*Náº¿u cÃ³ chá»— nÃ o sai hoáº·c tháº¯c máº¯c, cÃ¡c báº¡n hÃ£y gá»­i email vá» Ä‘á»‹a chá»‰ hÃ²m thÆ° mÃ¬nh Ä‘Ã­nh kÃ¨m bÃªn trÃ¡i trang nhÃ© ^^~*
